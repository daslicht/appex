declare module appex {
    interface IDisposable {
        dispose();
    }
}

declare module appex {
    interface CompilerResult {
        javascript: string;
        reflection: typescript.api.Reflection;
        diagnostics: typescript.api.Diagnostic[];
    }
}
declare module appex {
    class StopWatch {
        private starttime;
        public start(): void;
        public stop(): number;
    }
}


declare module node {
    var http: http;
    var fs: fs;
    var vm: vm;
    var path: path;
    var child_process: child_process;
    var url: url;
}

declare module appex {
    class ModuleExport {
        public scope: string[];
        public type: typescript.api.ReflectedType;
        constructor(scope: string[], type: typescript.api.ReflectedType);
    }
}


declare module appex {
    class Route {
        public moduleExport: appex.ModuleExport;
        public type: string;
        public url: string;
        public inputType: typescript.api.Type;
        public outputType: typescript.api.Type;
        constructor(moduleExport: appex.ModuleExport);
        private setup();
        private setup_url(method);
        private setup_type(method);
    }
}

declare module appex {
    interface IRuntimeOptions {
        sourcefile: string;
        devmode?: boolean;
        logging?: boolean;
        stdout?: WritableStream;
        stderr?: WritableStream;
    }
    class RuntimeOptions implements IRuntimeOptions {
        public sourcefile: string;
        public devmode: boolean;
        public logging: boolean;
        public stdout: WritableStream;
        public stderr: WritableStream;
        constructor(options: IRuntimeOptions);
    }
}

declare module appex {
    class RuntimeRequest {
        public serverRequest: http.ServerRequest;
        public serverResponse: http.ServerResponse;
        public next: () => void;
        public stopwatch: appex.StopWatch;
        constructor(serverRequest: http.ServerRequest, serverResponse: http.ServerResponse, next: () => void);
    }
}


declare module appex {
    class Worker<TRequest, TResponse> implements appex.IDisposable {
        public delegate: (request: TRequest, callback: (response: TResponse) => void) => void;
        private child_process;
        private waiters;
        private message_index;
        constructor(delegate: (request: TRequest, callback: (response: TResponse) => void) => void);
        private dispatch(message);
        public call(request: TRequest, callback: (response: TResponse) => void): void;
        public dispose(): void;
    }
}



declare module appex {
    class Compiler implements appex.IDisposable {
        private worker;
        constructor();
        public compile(filename: string, callback: (result: appex.CompilerResult) => void): void;
        public dispose(): void;
        private kernel(filename, callback);
    }
}



declare module appex {
    class Module implements appex.IDisposable {
        public javascript: string;
        public reflection: typescript.api.Reflection;
        public exports: appex.ModuleExport[];
        public context: any;
        constructor(javascript: string, reflection: typescript.api.Reflection);
        public get(moduleExport: appex.ModuleExport): any;
        private load_context();
        private load_exports();
        private load_variable(scope, variable);
        private load_parameter(scope, parameter);
        private load_method(scope, method);
        private load_class(scope, _class);
        private load_interface(scope, _interface);
        private load_import(scope, _import);
        private load_module(scope, _module);
        private load_script(scope, script);
        public dispose(): void;
    }
}




declare module appex {
    class Router {
        public module: appex.Module;
        public routes: appex.Route[];
        constructor(module: appex.Module);
        private read_request_object(request, callback);
        private write_response_object(output, response, callback);
        public request_handler(serverRequest: http.ServerRequest, serverResponse: http.ServerResponse, next?: () => void): boolean;
    }
}






declare module appex {
    class Runtime implements appex.IDisposable {
        private compiler;
        private module;
        private router;
        private runtime_request_queue;
        private options;
        private compiled;
        private compiling;
        constructor(options: appex.IRuntimeOptions);
        public request_handler(serverRequest: http.ServerRequest, serverResponse: http.ServerResponse, next: () => void): void;
        private prepare_module_and_router(callback);
        public dispose(): void;
    }
}









export declare function runtime(options: appex.IRuntimeOptions): (request: http.ServerRequest, response: http.ServerResponse, next: () => void) => void;
