// Copyright (c) 2013 haydn paterson (sinclair).  All rights reserved.
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/// <reference path="../../modules/IModule.ts" />
/// <reference path="../IContext.ts" />
/// <reference path="IRoute.ts" />

module appex.web.routing {

    /** appex wildcard route. handles wildcard routing and url parameters */
    export class WildcardRoute implements appex.web.routing.IRoute {
        
        /** regular expressions used in matching routes */
        public regexps : RegExp [];
        
        /** arguments:
        *       moduleExport : the module export for this route. (must be a function).
        */
        constructor(public moduleExport:appex.modules.IModuleExport) {
            
            this.regexps = [];

            this.initialize();
        }


        /** matches a route from the given request 
        *
        *   arguments:
        *       request : the nodejs http request to match.
        */        
        public match ( context : appex.web.IContext ) : boolean {

            var url       = node.url.parse(context.request.url);
            
            var cascade = this.moduleExport.cascade();

            if(cascade.verbs) {
                
                if( Object.prototype.toString.call( cascade.verbs ) === '[object Array]' ) {
                            
                    for(var n in cascade.verbs ) {
                            
                        if( Object.prototype.toString.call( cascade.verbs[n] ) === '[object String]' ) {
                            
                            if(cascade.verbs[n].toLowerCase() == context.request.method.toLowerCase()) {
                                    
                                for(var n in this.regexps) {
                                    
                                    if(this.regexps[n].test(url.pathname)) {
                                    
                                        return true;
                                    }
                                }
                            }
                            return false;
                        }
                        return false;
                    }
                    return false;
                }
            }
            else
            {
                for(var n in this.regexps) {
                                    
                    if(this.regexps[n].test(url.pathname)) {
                                    
                        return true;
                    }
                }
            }
        }


        /** invokes the target.
        *
        *   arguments:
        *       method  : the method to invoke.
        *       context : the context.
        */
        private invoke(method, parameters, context:appex.web.Context): void {
            
            var stack = [];

            var index = 0;

            var next  = function() {
                
                if(stack.length > 0) {
                
                    var middleware = stack.pop();
                    
                    context.next = next;

                    middleware(context);
                } 
                else {

                    method.apply(this, parameters);
                }
            }

            // if use.. invoke the middleware stack.
            if(context.cascade.use) {

                if( Object.prototype.toString.call( context.cascade.use ) === '[object Array]' ) {

                    for(var i = (context.cascade.use.length - 1); i >= 0; i--) {

                        if( Object.prototype.toString.call( context.cascade.use[i] ) === '[object Function]' ) {

                            stack.push( context.cascade.use[i] )
                        }
                    }

                    next();

                    return;
                }
            }

            method.apply(this, parameters);
        }

        /** handles route invocation.
        *
        *   arguments:
        *       context  - the context.
        *       request  - the nodejs http request.
        *       response - the nodejs http response.
        *       returns  - success if the route was handled.
        */
        public handler( context : appex.web.IContext ) : boolean {

            var method = this.moduleExport.accessor();

            if(method) {

                var url = node.url.parse( context.request.url );

                var parameters = this.arguments(url.pathname);

                parameters.unshift( context );

                context.cascade = this.moduleExport.cascade();

                this.invoke(method, parameters, context);
                
                return true;
            }

            throw new Error("appex.web.routing.ModuleWildcardRoute : unable to load accessor from moduleExport.");

            return false;
        }


        /** initializes this route */
        private initialize() : void {

            var method = <typescript.api.Method>this.moduleExport.type;
            
            var scope  = method.scope;

            if(scope.length > 0) {

                if(scope[0].indexOf('"') !== -1) {
                    
                    scope = scope.slice(1);
                }
            }
            
            // single argument
            if(method.parameters.length == 2) {
                
                var parameter = <typescript.api.Parameter>method.parameters[1];

                var buffer = [];

                buffer.push("^");

                if(scope.length > 0) 
                {
                    buffer.push('/', scope.join('/'));
                } 
                if(parameter.type.name == 'number') 
                { 
                    buffer.push('/([0-9]*)');
                }
                else if(parameter.type.name == 'boolean')
                {
                    buffer.push('/(true|false)');
                }
                else 
                {   
                    buffer.push('/(.*)');
                }
                buffer.push("$");          

                this.regexps.push( new RegExp(buffer.join('')) );
            }
            // multiple augments.
            else 
            {
                var last = method.parameters.length - 1;
            
                while(last != 0)    
                {
                    var buffer = [];

                    buffer.push("^");

                    if(scope.length > 0) {

                        buffer.push('/', scope.join('/'));
                    }

                    for(var i = 1; i < (last + 1); i++) {
                
                        var parameter = <typescript.api.Parameter>method.parameters[i];

                        if(parameter.type.name == 'number') 
                        { 
                            buffer.push('/([0-9]*)');
                        }
                        else if(parameter.type.name == 'boolean')
                        {
                            buffer.push('/(true|false)');
                        }
                        else 
                        {
                            buffer.push('/([^/]+)');
                        }
                    }

                    buffer.push('$');

                    this.regexps.push( new RegExp(buffer.join('')) );

                    if(!method.parameters[last].isOptional) {

                        break;
                    }

                    last = last - 1;
                }
            }
        }
        
        /** loads arguments from the url.
        *
        *   arguments:
        *       url : the url pathname
        *       returns: an array of arguments to applied to the invocation target.
        */
        private arguments (url : string) : any [] {

            var arguments = [];

            for(var n in this.regexps) {
                                    
                var match = this.regexps[n].exec(url);

                if(match) {
                    
                    var method = <typescript.api.Method>this.moduleExport.type;

                    var index  = 0;

                    for(var n in match) {

                        if(n != '0' && n != 'index' && n != 'input') {

                            var arg:any = match[n];

                            if(method.parameters[index + 1].type.name == 'number') {
                                
                                arg = parseFloat(arg);
                            }

                            if(method.parameters[index + 1].type.name == 'boolean') {

                                arg = (arg == 'true');
                                
                            }
                            arguments.push(arg);

                            index += 1;
                        }
                    }

                    return arguments;
                }
            }  

            return arguments;
        }
    }
}