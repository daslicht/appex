// Copyright (c) 2013 haydn paterson (sinclair).  All rights reserved.
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/// <reference path="../../modules/IModule.ts" />
/// <reference path="../app/IApp.ts" />
/// <reference path="IRoute.ts" />

module appex.web.routing {

    /** appex named route. handles named routes / function */
    export class ModuleNamedRoute implements appex.web.routing.IRoute {
        
        /** the pathname used to match this route. */
        public pathname : string;


        /** arguments:
        *       moduleExport : the module export for this route. (must be a function).
        */
        constructor(public moduleExport : appex.modules.IModuleExport) {
            
            this.initialize();
        }


        /** matches a route from the given request 
        *
        *   arguments:
        *       request : the nodejs http request to match.
        */
        public match ( request : http.ServerRequest) : boolean {
            
            var url       = node.url.parse(request.url);
            
            var attribute = this.moduleExport.attribute();

            if(attribute.verbs) {
                
                if( Object.prototype.toString.call( attribute.verbs ) === '[object Array]' ) {
                            
                    for(var n in attribute.verbs ) {
                            
                        if( Object.prototype.toString.call( attribute.verbs[n] ) === '[object String]' ) {
                            
                            if(attribute.verbs[n].toLowerCase() == request.method.toLowerCase()) {
                                    
                                return this.pathname == url.pathname;
                            }
                            return false;
                        }
                        return false;
                    }
                    return false;
                }
            } 
            else 
            {
                 return this.pathname == url.pathname;              
            }
        }


        /** handles route invocation.
        *
        *   arguments:
        *       app      - the application context.
        *       request  - the nodejs http request.
        *       response - the nodejs http response.
        *       returns  - success if the route was handled.
        */
        public handler ( app : appex.web.app.IApp, request:http.ServerRequest, response:http.ServerResponse ) : boolean {
        
            var accessor = this.moduleExport.accessor();
            
            if(accessor) {

                var attribute = this.moduleExport.attribute();

                if(attribute) {
                    
                    app.attribute = attribute;
                }
                            
                accessor(app);

                return true;
            }

            throw new Error('appex.web.routing.ModuleNamedRoute : unable to load accessor from moduleExport.');

            return false;
        }


        /** initializes this route */
        private initialize() : void {
            
            var method = <typescript.api.Method>this.moduleExport.type;

            var scope  = method.scope;

            if(scope.length > 0) {

                if(scope[0].indexOf('"') !== -1) {
                    
                    scope = scope.slice(1);
                }
            }

            if(scope.length == 0) 
            {        
                this.pathname = '/' + method.name;
            } 
            else  
            {
                this.pathname = '/' + scope.join('/') + '/' + method.name;
            }        
        }
    }
}