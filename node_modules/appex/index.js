var node;
(function (node) {
    node.http = require('http');

    node.fs = require('fs');
})(node || (node = {}));

var tsapi = require('typescript.api');
//@ sourceMappingURL=references.js.map
var appex;
(function (appex) {
    (function (activation) {
        var Reflection = (function () {
            function Reflection() {
                this.scripts = new Array();
            }
            return Reflection;
        })();
        activation.Reflection = Reflection;

        var Runtime = (function () {
            function Runtime() {
                this.reflection = new appex.activation.Reflection();
            }
            Runtime.prototype.start = function (sourcefile, callback) {
                var _this = this;
                tsapi.reset();

                var sources = [sourcefile];

                tsapi.resolve(sources, function (resolved) {
                    tsapi.compile(resolved, function (compiled) {
                        tsapi.run(compiled, null, function (context) {
                            _this.context = context;

                            for (var n in compiled) {
                                _this.reflection.scripts.push(compiled[n].reflection);
                            }

                            callback(_this.context, _this.reflection);
                        });
                    });
                });
            };
            return Runtime;
        })();
        activation.Runtime = Runtime;
    })(appex.activation || (appex.activation = {}));
    var activation = appex.activation;
})(appex || (appex = {}));
//@ sourceMappingURL=Runtime.js.map
var appex;
(function (appex) {
    (function (activation) {
        var ActivationHandle = (function () {
            function ActivationHandle() {
            }
            ActivationHandle.prototype.activate = function () {
                try  {
                    return new this.constructor();
                } catch (e) {
                    return null;
                }
            };
            return ActivationHandle;
        })();
        activation.ActivationHandle = ActivationHandle;
    })(appex.activation || (appex.activation = {}));
    var activation = appex.activation;
})(appex || (appex = {}));
//@ sourceMappingURL=ActivationHandle.js.map
var appex;
(function (appex) {
    (function (servicehost) {
        var Route = (function () {
            function Route() {
            }
            Route.prototype.call = function (input, callback) {
                console.log('calling -> ' + this.method);

                return this.instance[this.method](input, callback);
            };
            return Route;
        })();
        servicehost.Route = Route;
    })(appex.servicehost || (appex.servicehost = {}));
    var servicehost = appex.servicehost;
})(appex || (appex = {}));
//@ sourceMappingURL=Route.js.map
var appex;
(function (appex) {
    (function (activation) {
        var ActivationContext = (function () {
            function ActivationContext(runtime) {
                var _this = this;
                this.runtime = runtime;

                this.scope_stack = new Array();

                this.handles = new Array();

                this.runtime.reflection.scripts.forEach(function (script) {
                    _this.load_script(script);
                });

                delete this.scope_stack;
            }
            ActivationContext.prototype.load_handle = function (_class) {
                var scope = this.runtime.context;

                var stack = [];

                for (var i = 1; i < this.scope_stack.length; i++) {
                    stack.push(this.scope_stack[i]);
                }

                for (var n in stack) {
                    try  {
                        scope = scope[stack[n]];
                    } catch (e) {
                        scope = null;

                        break;
                    }
                }

                if (scope) {
                    if (scope[_class.name]) {
                        var instance = new activation.ActivationHandle();

                        instance.typename = stack.join('.') + '.' + _class.name;

                        instance.constructor = scope[_class.name];

                        instance.typeinfo = _class;

                        this.handles.push(instance);
                    }
                }
            };

            ActivationContext.prototype.load_module = function (_module) {
                var _this = this;
                this.scope_stack.push(_module.name);

                _module.modules.forEach(function (obj) {
                    _this.load_module(obj);
                });

                _module.imports.forEach(function (obj) {
                    _this.load_import(obj);
                });

                _module.interfaces.forEach(function (obj) {
                    _this.load_interface(obj);
                });

                _module.classes.forEach(function (obj) {
                    _this.load_class(obj);
                });

                _module.methods.forEach(function (obj) {
                    _this.load_method(obj);
                });

                _module.variables.forEach(function (obj) {
                    _this.load_variable(obj);
                });

                this.scope_stack.pop();
            };

            ActivationContext.prototype.load_import = function (_import) {
            };

            ActivationContext.prototype.load_class = function (_class) {
                var _this = this;
                this.load_handle(_class);

                _class.methods.forEach(function (obj) {
                    _this.load_method(obj);
                });

                _class.variables.forEach(function (obj) {
                    _this.load_variable(obj);
                });
            };

            ActivationContext.prototype.load_interface = function (_interface) {
                var _this = this;
                _interface.methods.forEach(function (obj) {
                    _this.load_method(obj);
                });

                _interface.variables.forEach(function (obj) {
                    _this.load_variable(obj);
                });
            };

            ActivationContext.prototype.load_method = function (method) {
                var _this = this;
                method.parameters.forEach(function (obj) {
                    _this.load_parameter(obj);
                });
            };

            ActivationContext.prototype.load_parameter = function (parameter) {
            };

            ActivationContext.prototype.load_variable = function (variable) {
            };

            ActivationContext.prototype.load_script = function (script) {
                var _this = this;
                script.modules.forEach(function (obj) {
                    _this.load_module(obj);
                });

                script.interfaces.forEach(function (obj) {
                    _this.load_interface(obj);
                });

                script.classes.forEach(function (obj) {
                    _this.load_class(obj);
                });

                script.methods.forEach(function (obj) {
                    _this.load_method(obj);
                });

                script.variables.forEach(function (obj) {
                    _this.load_variable(obj);
                });
            };
            return ActivationContext;
        })();
        activation.ActivationContext = ActivationContext;
    })(appex.activation || (appex.activation = {}));
    var activation = appex.activation;
})(appex || (appex = {}));
//@ sourceMappingURL=ActivationContext.js.map
var appex;
(function (appex) {
    (function (servicehost) {
        var Host = (function () {
            function Host(activation) {
                this.activation = activation;

                this.setup();
            }
            Host.prototype.call = function (path, input) {
                for (var n in this.routes) {
                    if (this.routes[n].path == path) {
                        var output = this.routes[n].call(input);

                        return output;
                    }
                }

                return null;
            };

            Host.prototype.setup = function () {
                var _this = this;
                this.routes = new Array();

                this.activation.handles.forEach(function (handle) {
                    var instance = handle.activate();

                    var basepath = '/' + handle.typename.replace(/\./g, '/');

                    basepath = basepath.replace(/\/\//g, '/');

                    handle.typeinfo.methods.forEach(function (method) {
                        if (!method.isConstructor) {
                            var route = new appex.servicehost.Route();

                            route.path = [basepath, method.name].join('/').toLowerCase();

                            route.instance = instance;

                            route.method = method.name;

                            if (method.parameters.length == 1) {
                                route.async = false;

                                route.input = method.parameters[0].type;

                                route.output = method.returns;
                            }

                            if (method.parameters.length == 2) {
                                if (method.parameters[1].type.name == "Function") {
                                    route.async = true;

                                    route.input = method.parameters[0].type;

                                    route.output = method.parameters[1].type;
                                }
                            }

                            _this.routes.push(route);
                        }
                    });
                });
            };

            Host.prototype.read_body = function (request, callback) {
                var buffer = [];

                request.on('data', function (chunk) {
                    buffer.push(chunk);
                });

                request.on('end', function () {
                    callback(buffer.join(''));
                });
            };

            Host.prototype.error_handler = function (error, request, response) {
                response.writeHead(500, { 'content-type': 'text/plain' });

                response.write(error.toString());

                response.end();
            };

            Host.prototype.discovery_handler = function (request, response) {
                response.writeHead(200, { 'content-type': 'text/plain' });

                response.write('output meta info here.');

                response.end();
            };

            Host.prototype.route_handler = function (context, request, response, callback) {
                var _this = this;
                if (this.routes.length == 0) {
                    callback(false);

                    return;
                }

                var handled = false;

                for (var n in this.routes) {
                    var route = this.routes[n];

                    if (route.path == request.url) {
                        handled = true;

                        route.instance.context = context;

                        var buffer = [];

                        this.read_body(request, function (buffer) {
                            var input = null;

                            try  {
                                input = JSON.parse(buffer);
                            } catch (e) {
                            }

                            try  {
                                if (route.async) {
                                    route.call(input, function (output) {
                                        var json = 'null';

                                        if (output) {
                                            json = JSON.stringify(output, null, ' ');
                                        }

                                        response.writeHead(200, { 'content-type': 'application/json' });

                                        response.write(json);

                                        response.end();

                                        callback(handled);
                                    });
                                } else {
                                    var output = route.call(input);

                                    var json = 'null';

                                    if (output) {
                                        json = JSON.stringify(output, null, ' ');
                                    }

                                    response.writeHead(200, { 'content-type': 'application/json' });

                                    response.write(json);

                                    response.end();

                                    callback(handled);

                                    return;
                                }
                            } catch (error) {
                                _this.error_handler(error.toString(), request, response);

                                callback(handled);

                                return;
                            }
                        });

                        break;
                    }
                }
                callback(handled);
            };

            Host.prototype.bind = function (server) {
                var _this = this;
                var listeners = server.listeners('request');

                server.removeAllListeners('request');

                server.on('request', function (request, response) {
                    if (request.url == '/appex') {
                        if (_this.discovery) {
                            _this.discovery_handler(request, response);

                            return;
                        }
                    }

                    var context = {
                        server: server,
                        request: request,
                        response: response
                    };

                    _this.route_handler(context, request, response, function (handled) {
                        if (!handled) {
                            for (var n in listeners) {
                                listeners[n](request, response);
                            }
                        }
                    });
                });
            };
            return Host;
        })();
        servicehost.Host = Host;
    })(appex.servicehost || (appex.servicehost = {}));
    var servicehost = appex.servicehost;
})(appex || (appex = {}));
//@ sourceMappingURL=Host.js.map
function create_runtime(source, callback) {
    var runtime = new appex.activation.Runtime();

    runtime.start(source, function (context, reflection) {
        callback(runtime);
    });
}

function create_activation_context(runtime, callback) {
    var activation = new appex.activation.ActivationContext(runtime);

    callback(activation);
}

function create_service_host(activation_context, callback) {
    var service_host = new appex.servicehost.Host(activation_context);

    callback(service_host);
}

function create(source, callback) {
    create_runtime(source, function (runtime) {
        create_activation_context(runtime, function (activation_context) {
            create_service_host(activation_context, function (service_host) {
                callback(service_host);
            });
        });
    });
}
exports.create = create;

function listen(server, source) {
    exports.create(source, function (host) {
        host.bind(server);
    });
}
exports.listen = listen;

//@ sourceMappingURL=index.js.map
